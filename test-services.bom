brooklyn.catalog:
  id: mysqldb-test-services
  name: MySQL Database Test Services
  itemType: entity
  description: Services for tests of MySQL Database Server

  items:

  - name: Master-Slave Test
    type: org.apache.brooklyn.entity.stock.BasicApplication

    brooklyn.children:

    - type: org.apache.brooklyn.entity.software.base.SameServerEntity
      name: Master
      brooklyn.children:
      - type: mysql-server
        id: dbserver
        brooklyn.config:
          root.password: password
          login.user: someuser
          login.password: password
          replication.password: password
          server.id: 1

      - type: mysql-database
        name: Classic Models
        id: database
        brooklyn.config:
          login.user: someuser
          server: dbserver
          latch.start: $brooklyn:component("repl-slave").attributeWhenReady("service.isUp")
          databaseName: classicmodels
          schema.create.url: https://raw.githubusercontent.com/brooklyncentral/brooklyn-mysql-yaml/master/classicmodels.schema

    - type: org.apache.brooklyn.entity.software.base.SameServerEntity
      name: Slave
      brooklyn.children:

      - type: mysql-slave
        id: repl-slave
        name: replication slave
        brooklyn.config:
          latch.start: $brooklyn:component("dbserver").attributeWhenReady("service.isUp")
          server: dbserver
          root.password: password
          login.user: someuser
          login.password: password
          server.id: 2
          replication.password: $brooklyn:component("dbserver").config("replication.password")

  - name: Single-Node Test
    type: org.apache.brooklyn.entity.stock.BasicApplication

    brooklyn.children:

    - type: org.apache.brooklyn.entity.software.base.SameServerEntity
      name: MySQL Single Node

      brooklyn.children:
      - type: mysql-server
        id: dbserver
        brooklyn.config:
          root.password: password
          login.user: someuser
          login.password: password

      - type: mysql-database
        name: Classic Models
        id: database
        brooklyn.config:
          login.user: someuser
          server: dbserver
          latch.start: $brooklyn:component("dbserver").attributeWhenReady("service.process.isRunning")
          databaseName: classicmodels
          schema.create.url: https://raw.githubusercontent.com/brooklyncentral/brooklyn-mysql-yaml/master/classicmodels.schema
